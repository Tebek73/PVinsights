<div class="wizard">
  <header class="wizard-header">
    <h2>{{ 'wizard.title' | translate }}</h2>
    <p>{{ 'wizard.subtitle' | translate }}</p>

    <ol class="wizard-steps">
      <li [class.active]="step() === 1">{{ 'wizard.step1' | translate }}</li>
      <li [class.active]="step() === 2">{{ 'wizard.step2' | translate }}</li>
      <li [class.active]="step() === 3">{{ 'wizard.step3' | translate }}</li>
    </ol>
  </header>

  <section class="wizard-body">
    <!-- Step 1: Area type then location -->
    <ng-container *ngIf="step() === 1">
      <h3>{{ 'wizard.step1' | translate }}</h3>

      <p class="wizard-body-text">{{ 'wizard.areaTypeQuestion' | translate }}</p>
      <div class="wizard-area-type">
        <label>
          <select
            [ngModel]="area_type()"
            (ngModelChange)="area_type.set($event || null)"
          >
            <option value="">{{ 'wizard.areaTypePlaceholder' | translate }}</option>
            <option value="rural">{{ 'wizard.areaTypeRural' | translate }}</option>
            <option value="suburban">{{ 'wizard.areaTypeSuburban' | translate }}</option>
            <option value="urban">{{ 'wizard.areaTypeUrban' | translate }}</option>
          </select>
        </label>
      </div>

      <div
        class="wizard-location-block"
        [class.wizard-location-visible]="area_type() !== null"
      >
        <p class="wizard-body-text">{{ 'wizard.location.hint' | translate }}</p>
        <app-location-picker
          [lat]="lat()"
          [lon]="lon()"
          (latLonChange)="onLatLonChange($event)"
        />
      </div>
    </ng-container>

    <!-- Step 2: PV system -->
    <ng-container *ngIf="step() === 2">
      <h3>{{ 'wizard.step2' | translate }}</h3>
      <p class="wizard-body-text">{{ 'wizard.pv.hint' | translate }}</p>

      <div class="wizard-grid">
        <label>
          {{ 'wizard.systemSize' | translate }}
          <input
            type="number"
            min="0"
            step="0.1"
            [ngModel]="peakpower_kw()"
            (ngModelChange)="peakpower_kw.set($event)"
          />
        </label>

        <label>
          {{ 'wizard.systemLosses' | translate }}
          <input
            type="number"
            min="0"
            max="80"
            step="1"
            [ngModel]="loss_percent()"
            (ngModelChange)="loss_percent.set($event)"
          />
        </label>
      </div>

      <div class="wizard-grid">
        <label class="checkbox">
          <input
            type="checkbox"
            [ngModel]="usehorizon()"
            (ngModelChange)="usehorizon.set($event)"
          />
          {{ 'wizard.useHorizon' | translate }}
        </label>

        <label class="checkbox">
          <input
            type="checkbox"
            [ngModel]="optimalangles()"
            (ngModelChange)="optimalangles.set($event)"
          />
          {{ 'wizard.optimalAngles' | translate }}
        </label>
      </div>

      <details class="wizard-advanced">
        <summary>{{ 'wizard.advancedPv' | translate }}</summary>

        <div class="wizard-grid wizard-grid-3">
          <label>
            {{ 'wizard.tiltAngle' | translate }}
            <input
              type="number"
              min="0"
              max="90"
              [disabled]="optimalangles()"
              [ngModel]="angle_deg()"
              (ngModelChange)="angle_deg.set($event)"
            />
          </label>

          <label>
            {{ 'wizard.azimuth' | translate }}
            <input
              type="number"
              min="-180"
              max="180"
              [disabled]="optimalangles()"
              [ngModel]="aspect_deg()"
              (ngModelChange)="aspect_deg.set($event)"
            />
          </label>

          <label>
            {{ 'wizard.pvTech' | translate }}
            <select
              [ngModel]="pvtechchoice()"
              (ngModelChange)="pvtechchoice.set($event)"
            >
              <option value="crystSi">{{ 'pvTech.crystSi' | translate }}</option>
              <option value="crystSi2025">{{ 'pvTech.crystSi2025' | translate }}</option>
              <option value="CIS">{{ 'pvTech.CIS' | translate }}</option>
              <option value="CdTe">{{ 'pvTech.CdTe' | translate }}</option>
              <option value="Unknown">{{ 'pvTech.Unknown' | translate }}</option>
            </select>
          </label>
        </div>

        <div class="wizard-grid">
          <label>
            {{ 'wizard.mounting' | translate }}
            <select
              [ngModel]="mountingplace()"
              (ngModelChange)="mountingplace.set($event)"
            >
              <option value="free">{{ 'wizard.mountingFree' | translate }}</option>
              <option value="building">{{ 'wizard.mountingBuilding' | translate }}</option>
            </select>
          </label>

          <label>
            {{ 'wizard.radDatabase' | translate }}
            <input
              type="text"
              [placeholder]="'wizard.radPlaceholder' | translate"
              [ngModel]="raddatabase()"
              (ngModelChange)="raddatabase.set($event || null)"
            />
          </label>
        </div>
      </details>
    </ng-container>

    <!-- Step 3: Economics -->
    <ng-container *ngIf="step() === 3">
      <h3>{{ 'wizard.step3' | translate }}</h3>
      <p class="wizard-body-text">{{ 'wizard.economics.hint' | translate }}</p>

      <div class="wizard-grid">
        <label>
          {{ 'wizard.capex' | translate }}
          <input
            type="number"
            min="0"
            step="100"
            [ngModel]="capex()"
            (ngModelChange)="capex.set($event)"
          />
        </label>

        <label>
          {{ 'wizard.priceBuy' | translate }}
          <input
            type="number"
            min="0"
            step="0.01"
            [ngModel]="price_buy()"
            (ngModelChange)="price_buy.set($event)"
          />
        </label>
      </div>

      <div class="wizard-grid">
        <label>
          {{ 'wizard.selfConsumption' | translate }}
          <input
            type="number"
            min="0"
            max="100"
            step="5"
            [ngModel]="self_consumption() * 100"
            (ngModelChange)="self_consumption.set(($event ?? 0) / 100)"
          />
        </label>

        <label>
          {{ 'wizard.priceSell' | translate }}
          <input
            type="number"
            min="0"
            step="0.01"
            [ngModel]="price_sell()"
            (ngModelChange)="price_sell.set($event)"
          />
        </label>
      </div>

      <details class="wizard-advanced">
        <summary>{{ 'wizard.advancedEconomics' | translate }}</summary>

        <div class="wizard-grid wizard-grid-3">
          <label>
            {{ 'wizard.opex' | translate }}
            <input
              type="number"
              min="0"
              step="50"
              [ngModel]="opex_yearly()"
              (ngModelChange)="opex_yearly.set($event)"
            />
          </label>

          <label>
            {{ 'wizard.degradation' | translate }}
            <input
              type="number"
              min="0"
              max="5"
              step="0.1"
              [ngModel]="degradation() * 100"
              (ngModelChange)="degradation.set(($event ?? 0) / 100)"
            />
          </label>

          <label>
            {{ 'wizard.analysisYears' | translate }}
            <input
              type="number"
              min="1"
              max="40"
              step="1"
              [ngModel]="analysis_years()"
              (ngModelChange)="analysis_years.set($event)"
            />
          </label>
        </div>

        <div class="wizard-grid">
          <label>
            {{ 'wizard.discountRate' | translate }}
            <input
              type="number"
              min="0"
              max="20"
              step="0.5"
              [ngModel]="discount_rate() * 100"
              (ngModelChange)="discount_rate.set(($event ?? 0) / 100)"
            />
          </label>

          <label>
            {{ 'wizard.priceEscalation' | translate }}
            <input
              type="number"
              min="0"
              max="10"
              step="0.5"
              [ngModel]="price_escalation() * 100"
              (ngModelChange)="price_escalation.set(($event ?? 0) / 100)"
            />
          </label>
        </div>
      </details>
    </ng-container>
  </section>

  <footer class="wizard-footer">
    <div class="wizard-footer-left">
      <button
        type="button"
        class="wizard-nav-button"
        [disabled]="step() === 1 || store.isLoading()"
        (click)="prevStep()"
      >
        {{ 'wizard.back' | translate }}
      </button>

      <button
        type="button"
        class="wizard-nav-button"
        *ngIf="step() < 3"
        [disabled]="!canGoNext() || store.isLoading()"
        (click)="nextStep()"
      >
        {{ 'wizard.next' | translate }}
      </button>

      <button
        type="button"
        class="wizard-submit-button"
        *ngIf="step() === 3"
        [disabled]="store.isLoading()"
        (click)="submit()"
      >
        <span *ngIf="!store.isLoading()">{{ 'wizard.runSimulation' | translate }}</span>
        <span *ngIf="store.isLoading()">{{ 'wizard.running' | translate }}</span>
      </button>
    </div>
  </footer>

  <!-- Error pop-up -->
  @if (store.errorMessage()) {
    <div class="wizard-error-overlay" (click)="closeError()" role="dialog" aria-modal="true" aria-labelledby="error-dialog-title">
      <div class="wizard-error-dialog" (click)="$event.stopPropagation()">
        <h3 id="error-dialog-title" class="wizard-error-dialog-title">{{ 'wizard.errorTitle' | translate }}</h3>
        <p class="wizard-error-dialog-message">{{ store.errorMessage() }}</p>
        <button type="button" class="wizard-error-dialog-close" (click)="closeError()">
          {{ 'wizard.close' | translate }}
        </button>
      </div>
    </div>
  }
</div>

