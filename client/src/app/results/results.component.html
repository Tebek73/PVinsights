<div class="results">
  <header class="results-header">
    <h2>{{ 'results.title' | translate }}</h2>
    <p>{{ 'results.subtitle' | translate }}</p>
  </header>

  <ng-container *ngIf="store.lastResponse() as res; else emptyState">
    <section class="results-kpis">
      <div class="kpi-card">
        <h3>{{ 'results.annualEnergy' | translate }}</h3>
        <p class="kpi-value">{{ res.kpis.annual_kwh | number: '1.0-0' }} {{ 'results.unitKwhYear' | translate }}</p>
      </div>

      <div class="kpi-card">
        <h3>{{ 'results.specificYield' | translate }}</h3>
        <p class="kpi-value">
          {{ res.kpis.specific_yield_kwh_per_kwp | number: '1.0-0' }} {{ 'results.unitKwhKwpYear' | translate }}
        </p>
      </div>

      <div class="kpi-card">
        <h3>{{ 'results.capacityFactor' | translate }}</h3>
        <p class="kpi-value">{{ res.kpis.capacity_factor_pct | number: '1.1-1' }} %</p>
      </div>

      <div class="kpi-card">
        <h3>{{ 'results.payback' | translate }}</h3>
        <p class="kpi-value">
          <ng-container *ngIf="res.finance.payback_years !== null; else noPayback">
            {{ res.finance.payback_years }} {{ 'results.years' | translate }}
          </ng-container>
          <ng-template #noPayback>n/a</ng-template>
        </p>
      </div>

      <div class="kpi-card">
        <h3>{{ 'results.year1Savings' | translate }}</h3>
        <p class="kpi-value">
          {{ res.finance.savings_year1 | number: '1.0-0' }}
        </p>
      </div>

      <div class="kpi-card">
        <h3>{{ 'results.roi' | translate }}</h3>
        <p class="kpi-value">
          <ng-container *ngIf="res.finance.roi !== null; else noRoi">
            {{ (res.finance.roi * 100) | number: '1.0-0' }} %
          </ng-container>
          <ng-template #noRoi>n/a</ng-template>
        </p>
      </div>
    </section>

    <section class="results-charts">
      <div class="chart-card">
        <h3>{{ 'results.monthlyProduction' | translate }}</h3>
        <div class="chart-bars" *ngIf="monthlyEnergy().length > 0">
          <div
            class="chart-bar-row"
            *ngFor="let m of monthlyEnergy()"
          >
            <span class="chart-bar-label">M{{ m.month }}</span>
            <div class="chart-bar-track">
              <div
                class="chart-bar-fill"
                [style.width.%]="(m.kwh / maxMonthlyEnergy()) * 100"
              ></div>
            </div>
            <span class="chart-bar-value">
              {{ m.kwh | number: '1.0-0' }}
            </span>
          </div>
        </div>
      </div>

      <div class="chart-card">
        <h3>{{ 'results.cumulativeCashflow' | translate }}</h3>
        <div class="chart-bars" *ngIf="cashflow().length > 0">
          <div
            class="chart-bar-row"
            *ngFor="let p of cashflow()"
          >
            <span class="chart-bar-label">Y{{ p.year }}</span>
            <div class="chart-bar-track chart-bar-track-cashflow">
              <div
                class="chart-bar-fill chart-bar-fill-cashflow"
                [class.negative]="p.value < 0"
                [style.width.%]="
                  (Math.abs(p.value) / (maxCashflow() || 1)) * 100
                "
              ></div>
            </div>
            <span class="chart-bar-value">
              {{ p.value | number: '1.0-0' }}
            </span>
          </div>
        </div>
      </div>
    </section>

    <section class="results-insights" *ngIf="res.insights.length > 0">
      <h3>{{ 'results.insights' | translate }}</h3>
      <ul>
        <li
          *ngFor="let insight of res.insights"
          [class.warning]="insight.type === 'warning'"
        >
          {{ getInsightText(insight) }}
        </li>
      </ul>
    </section>

    <footer class="results-footer">
      <button type="button" class="results-button" (click)="backToWizard()">
        {{ 'results.runNew' | translate }}
      </button>
    </footer>
  </ng-container>

  <ng-template #emptyState>
    <section class="results-empty">
      <p>{{ 'results.empty' | translate }}</p>
      <button type="button" class="results-button" (click)="backToWizard()">
        {{ 'results.backToWizard' | translate }}
      </button>
    </section>
  </ng-template>
</div>

